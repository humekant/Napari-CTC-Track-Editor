# 🧬 CTC Track Editor for Napari

**CTC Track Editor** 是一个专为 [Cell Tracking Challenge (CTC)](http://celltrackingchallenge.net/) 数据格式设计的 Napari 插件/小部件。

它旨在帮助研究人员高效地**可视化**、**校正**和**编辑**细胞追踪结果（Segmentation + Tracking）。通过直观的图形界面，用户可以轻松处理细胞的合并、拆分、谱系构建以及轨迹修正，并实时查看 3D 谱系关系。

---

## ✨ 核心功能

* **🚀 高速异步加载**: 采用多线程读取技术，支持快速加载大规模 TIFF 序列和对应的原始图像（Raw Data）。
* **🛠️ 全能编辑工具箱**:
* **合并 (Merge)**: 将过分割的片段合并，并自动处理谱系继承。
* **拆分 (Split)**: 将欠分割或错误连接的轨迹从指定帧切断并赋予新 ID。
* **谱系连接 (Lineage Linking)**: 手动建立父子关系（分裂事件）。
* **删除 (Delete)**: 支持全局物理删除或从当前帧开始的截断删除。


* **🌲 3D 谱系可视化**: 实时更新 Napari 的 `Tracks` 层，直观展示细胞分裂树和运动轨迹。
* **📝 实时日志系统**: 内置控制台显示操作历史、错误警告及处理进度。
* **💾 CTC 标准导出**: 自动生成符合 CTC 标准的 `man_seg*.tif` 序列及 `man_track.txt` 谱系文件。

---

## 📦 环境依赖

请确保您的 Python 环境中安装了以下库：

```bash
pip install napari[all] numpy pandas tifffile imageio scipy qtpy

```

*建议使用 Python 3.9 或更高版本。*

---

## 📂 数据格式要求 (CTC Format)

本工具遵循 Cell Tracking Challenge 的标准文件结构。

**文件夹结构示例：**

```text
Dataset/
├── 01/                  <-- Raw 原始图像 (可选)
│   ├── t000.tif
│   ├── t001.tif
│   └── ...
└── 01_RES/              <-- Mask 分割结果 (加载目标)
    ├── mask000.tif      (或 man_seg000.tif)
    ├── mask001.tif
    ├── ...
    └── res_track.txt    (或 man_track.txt) 谱系文件

```

* **Mask**: 16-bit 整数图像，背景为 0，每个细胞由唯一的整数 ID 标记。
* **Track TXT**: 文本文件，每行格式为 `L B E P` (Label, Begin, End, Parent)。

---

## 📖 使用指南

### 1. 启动编辑器

运行脚本启动 Napari：

```python
python main.py

```

插件界面将出现在 Napari 的右侧停靠栏中。

### 2. 数据导入

1. **Mask 路径**: 点击“浏览”选择包含分割结果（`.tif`）的文件夹。
2. **Raw 路径**: 可选。留空则程序会尝试自动在同级目录寻找 `01` 或 `02` 文件夹。
3. 点击 **`🚀 全异步高速加载数据`**。

### 3. 导航与查看

* **ID 跳转**: 在 `🔍 定位 ID` 框输入 ID，或点击下方表格中的某一行，视图将自动聚焦到该细胞。
* **时间跳转**: 使用 `⏮ 回到首帧` 或 Napari 底部的时间轴滑块。
* **信息表**: 实时显示当前帧所有细胞的 ID、生存周期（Start-End）及父节点 ID。

### 4. 编辑操作

| 功能 | 区域 | 说明 |
| --- | --- | --- |
| **合并** | `[3. 修改工具]` | 输入 **保留 ID** 和 **被并 ID**。点击 `🤝 合并轨迹` 后，被并 ID 的像素将变为保留 ID，且谱系关系会自动转移。 |
| **拆分** | `[3. 修改工具]` | 输入 **拆分 ID** 和 **起始帧**。点击 `✂️ 设为新细胞`，该 ID 从指定帧开始的所有像素将被赋予一个新的最大 ID。 |
| **谱系** | `[3. 修改工具]` | 输入 **父 P** 和 **子 A/B** 的 ID。点击 `🔗 建立谱系` 即可在轨迹图中连接它们。 |
| **删除** | `[4. 系统与辅助]` | `❌ 物理全删`: 清除该 ID 所有帧的像素。<br>

<br>`✂️ 截断删除`: 仅清除该 ID 从当前帧开始及之后的像素（用于修正追踪漂移）。 |
| **撤销** | `[4. 系统与辅助]` | 点击 `↩️ 撤销上一步` 可回退最近一次的编辑操作（支持多级撤销）。 |

### 5. 保存结果

* **💾 覆盖保存**: 将修改后的 Mask 和 TXT 文件保存到名为 `RES_modified` 的新文件夹中（位于原数据同级目录）。
* **📁 另存为...**: 自定义保存路径。

**注意**: 保存时会自动重新计算所有统计信息，并生成标准的 `man_track.txt`。

---

## ⌨️ 快捷技巧

* **可视化调整**: 可以调整 Napari 左侧图层列表中 `SegLabels` 的不透明度，以便对比 Raw 图像。
* **日志排错**: 如果操作没有反应，请查看插件底部的 **[ 6. 系统日志 ]** 黑色控制台，那里会显示详细的错误信息或成功提示。
* **3D 视图**: 点击 `✨ 刷新 3D 轨迹` 按钮，并在 Napari 中切换到 3D 视图（点击左下角方块图标），可以直观地看到细胞的分裂树结构。

---

## 📝 License

此项目仅供科研与学习使用。

---